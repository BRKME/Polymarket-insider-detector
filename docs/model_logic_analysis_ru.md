# Анализ и обновление логики детектора (RU)

## Что обновлено

В текущей версии детектора добавлен второй этап после базового insider-score:

1. **Insider scoring** — классический скоринг по кошельку, размеру ставки, таймингу, а также учёту позиций YES/NO.
2. **Irrationality + Mispricing** — оценка иррациональности рынка и статистического миспрайсинга.
3. **Combined signal gating (новое)** — финальный фильтр на уровне сигнала, который снижает шум.

## Проблема старой схемы

Раньше алерт отправлялся, если:

- базовый `analysis["score"] >= ALERT_THRESHOLD`,
- и не срабатывали фильтры `should_skip_alert`.

Даже при этом могли проходить кейсы:

- `CONFLICT` (инсайдер покупает YES в переоценённом рынке),
- слабые `INSIDER_ONLY` без таймингового подтверждения,
- в целом шумные сигналы, где combined-оценка не подтверждает edge.

## Новая логика (gating)

После расчёта `combined_signal` добавлены правила:

1. **Минимальная сила сигнала**
   - Если `signal_strength < ALERT_THRESHOLD` → алерт отбрасывается.

2. **CONFLICT без сильного подтверждения**
   - Если `signal_type == "CONFLICT"` и `insider_score < 100` → алерт отбрасывается.
   - Идея: конфликтные сигналы оставляем только при реально экстремальном инсайдерском скоре.

3. **INSIDER_ONLY без pre-event тайминга**
   - Если `signal_type == "INSIDER_ONLY"` и нет `latency_data` → алерт отбрасывается.
   - Идея: инсайдерский сигнал без миспрайсинга и без раннего тайминга чаще даёт FP.

## Что это даёт

- Меньше ложноположительных алертов в «серой зоне».
- Приоритет для сигналов, где есть согласование нескольких источников:
  - insider activity,
  - irrationality/mispricing,
  - или pre-event timing.
- Более стабильное качество алертов при том же `ALERT_THRESHOLD`.

## Примечание

Порог и правила gating можно вынести в `config.py`, если потребуется сделать их настраиваемыми per-env.


## Конфигурирование (final)

Параметры gating вынесены в `config.py`:

- `COMBINED_SIGNAL_MIN_STRENGTH`
- `CONFLICT_MIN_INSIDER_SCORE`
- `INSIDER_ONLY_REQUIRES_PRE_EVENT`

Это позволяет менять строгость фильтра без правок в `detector.py`.
