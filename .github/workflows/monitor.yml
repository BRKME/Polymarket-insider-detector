name: Polymarket Insider Detector (Updated Limits)

on:
  schedule:
    # Run every 2 minutes - based on real API data:
    # API returns 500 trades = ~16 seconds of market activity
    # Running every 2 minutes ensures full coverage with overlap
    - cron: '*/2 * * * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:

# Concurrency control: prevent race conditions
# Only one instance runs at a time, queued runs wait
concurrency:
  group: polymarket-insider-detector
  cancel-in-progress: false  # Don't cancel, wait for completion

# Grant write permissions for committing tracked wallets
permissions:
  contents: write

jobs:
  detect-insiders:
    runs-on: ubuntu-latest
    
    # Maximum execution time: 10 minutes (should complete in 20-30s)
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --break-system-packages requests openai
      
      - name: Verify environment variables
        run: |
          echo "Checking required secrets..."
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "❌ TELEGRAM_BOT_TOKEN not set"
            exit 1
          fi
          if [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "❌ TELEGRAM_CHAT_ID not set"
            exit 1
          fi
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "❌ OPENAI_API_KEY not set"
            exit 1
          fi
          echo "✓ All secrets configured"
      
      - name: Run insider detector
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "════════════════════════════════════════════════"
          echo "Starting Polymarket Insider Detector"
          echo "Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "════════════════════════════════════════════════"
          python main.py
          EXIT_CODE=$?
          echo "════════════════════════════════════════════════"
          echo "Detector finished with exit code: $EXIT_CODE"
          echo "════════════════════════════════════════════════"
          exit $EXIT_CODE
      
      - name: Commit and push changes
        if: success()
        run: |
          git config user.name "Polymarket Detector Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are any changes
          if git diff --quiet alerts.json tracked_wallets.json; then
            echo "No changes to commit"
          else
            echo "Changes detected, committing..."
            git add alerts.json tracked_wallets.json
            git commit -m "chore: update alerts and tracked wallets [skip ci]" || echo "No changes to commit"
            
            # Push with retry logic
            for i in {1..3}; do
              if git push; then
                echo "✓ Successfully pushed changes"
                break
              else
                echo "⚠️  Push failed, retry $i/3"
                sleep 5
                git pull --rebase origin main || true
              fi
            done
          fi
      
      - name: Report failure
        if: failure()
        run: |
          echo "════════════════════════════════════════════════"
          echo "❌ Workflow failed!"
          echo "Check logs above for details"
          echo "Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "════════════════════════════════════════════════"
          # Future: Send alert to monitoring system
